<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Report By Date</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2803e;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 30px auto 0 auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.12);
            padding: 2vw;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 2vw;
            letter-spacing: 1px;
        }
        .date-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .date-selector label {
            font-weight: bold;
        }
        .date-selector input[type="date"] {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .date-selector button {
            background: linear-gradient(90deg, #4CAF50 60%, #388e3c 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .date-selector button:hover {
            background: linear-gradient(90deg, #388e3c 60%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76,175,80,0.2);
        }
        .report-preview {
            margin-top: 30px;
        }
        .tables-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .table-section {
            flex: 1 1 350px;
            min-width: 320px;
            background: #fafafa;
            border-radius: 12px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.07);
            padding: 18px 10px 10px 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .table-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        th {
            background: #10dfff;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        td {
            background: #fff;
        }
        tr:hover td {
            background-color: #f5f5f5;
        }
        .summary {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        .summary-item:hover {
            transform: translateX(5px);
        }
        .summary-label {
            color: #666;
            font-weight: 600;
        }
        .summary-value {
            color: #333;
            font-weight: 700;
        }
        .download-btn {
            display: block;
            margin: 30px auto 0 auto;
            background: linear-gradient(90deg, #4CAF50 60%, #388e3c 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            background: linear-gradient(90deg, #388e3c 60%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76,175,80,0.2);
        }
        @media (max-width: 900px) {
            .tables-container {
                flex-direction: column;
                gap: 18px;
            }
        }
        @media print {
            .date-selector, .download-btn {
                display: none;
            }
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: 1px solid #ff4444;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: auto;
            height: auto;
            box-sizing: border-box;
        }
        .delete-btn:hover {
            background-color: #cc0000;
            border-color: #cc0000;
        }
        /* MODIFIED: Added style for table total text */
        .table-total {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1em;
            text-align: right;
            color: #333;
        }
        /* Enhanced responsive design */
        @media (max-width: 768px) {
            .container {
                width: 98%;
                padding: 15px;
            }
            .date-selector {
                flex-direction: column;
            }
            .tables-container {
                gap: 20px;
            }
            .table-section {
                min-width: 280px;
                padding: 15px 8px 8px 8px;
            }
            button {
                padding: 12px;
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                width: 100%;
                padding: 10px;
                border-radius: 10px;
            }
            .table-section {
                min-width: 100%;
                padding: 12px 5px 5px 5px;
            }
            th, td {
                padding: 8px 4px;
                font-size: 12px;
            }
            h2, h3, h4 {
                font-size: clamp(16px, 4vw, 20px);
            }
        }
        
        @media (min-width: 1200px) {
            .container {
                width: 85%;
            }
            .tables-container {
                gap: 40px;
            }
        }
    </style>
</head>
<body>
    {% include 'temple_app/nav_bar.html' %}
    <div class="container">
        <h2>View Report By Date</h2>
        <div class="date-selector">
            <label for="reportDate">Select Date:</label>
            <input type="date" id="reportDate" required max="">
            <button onclick="fetchReport()">Generate Report</button>
        </div>
        <div id="reportContainer" style="display: none;">
            <div class="report-preview">
                <h3>Report Preview</h3>
                <div class="tables-container">
                    <div class="table-section">
                        <h4>Opening Balance</h4>
                        <table id="obTable" class="table">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="obTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Ghee/Coconut Report</h4>
                        <table id="gcTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Receipt Range</th>
                                    <th>Receipts Count</th>
                                    <th>Total Cost</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="gcTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Maaladharane Report</h4>
                        <table id="mlTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Receipt Range</th>
                                    <th>Receipts Count</th>
                                    <th>Total Cost</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="mlTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Irumudi Report</h4>
                        <table id="irumudiTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Receipt Number</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="irumudiTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Donation Report</h4>
                        <table id="donationTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Receipt Number</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="donationTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Material Report</h4>
                        <table id="materialTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Receipt Number</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="materialTotal" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>UPI Report</h4>
                        <table id="upiTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="upiTotalDisplay" class="table-total"></div>
                    </div>
                    <div class="table-section">
                        <h4>Expense Report</h4>
                        <table id="expenseTable" class="table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Expense Name</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" style="text-align: center;">No data available</td></tr>
                            </tbody>
                        </table>
                        <div id="expenseTotalDisplay" class="table-total"></div>
                    </div>
                </div>
                <div class="summary">
                    <div class="summary-item">
                        <span class="summary-label">Opening Balance:</span>
                        <span class="summary-value" id="openingBalanceTotal">Rs. 0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">UPI Total:</span>
                        <span class="summary-value" id="upiTotal">Rs. 0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Expense Total:</span>
                        <span class="summary-value" id="expenseTotal">Rs. 0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Grand Total:</span>
                        <span class="summary-value" id="grandTotal">Rs. 0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cash Total:</span>
                        <span class="summary-value" id="cashTotal">Rs. 0</span>
                    </div>
                </div>
                <button class="download-btn" onclick="downloadPDF()">Download PDF</button>
            </div>
        </div>
    </div>
    <script>
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').max = today;
        };

        function fetchReport() {
            const selectedDate = document.getElementById("reportDate").value;
            if (!selectedDate) {
                alert("Please select a date.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDateObj = new Date(selectedDate);
            selectedDateObj.setHours(0, 0, 0, 0);

            if (selectedDateObj > today) {
                alert("Cannot select future dates. Please select today or a past date.");
                return;
            }

            $.ajax({
                url: '/fetch_report_by_date/',
                type: 'GET',
                data: { date: selectedDate },
                success: function(response) {
                    if (response.status === 'success') {
                        displayReport(response.data);
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error details:', xhr.responseText);
                    alert('Error fetching report. Please check console for details.');
                }
            });
        }

        function deleteRecord(tableType, recordId) {
            const selectedDate = document.getElementById("reportDate").value;
            if (!selectedDate) {
                alert("Please select a date first.");
                return;
            }

            if (!confirm("Are you sure you want to delete this record?")) {
                return;
            }

            $.ajax({
                url: '/delete-report-data/',
                type: 'GET',
                data: {
                    date: selectedDate,
                    table_type: tableType,
                    record_id: recordId
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('Record deleted successfully');
                        fetchReport(); // Refresh the report
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error details:', xhr.responseText);
                    alert('Error deleting record. Please check console for details.');
                }
            });
        }

        function formatDateToDMY(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function displayReport(data) {
            // Clear existing data
            $('table tbody').empty();
            $('.table-total').text('');

            // Initialize totals
            let gcTotal = 0, mlTotal = 0, irumudiTotal = 0, donationTotal = 0, materialTotal = 0, upiTotal = 0, expenseTotal = 0;

            // Display Opening Balance
            const obTable = document.getElementById('obTable');
            const obTableBody = obTable.querySelector('tbody');
            obTableBody.innerHTML = '';
            
            if (data.opening_balance) {
                obTableBody.innerHTML = `
                    <tr>
                        <td>1</td>
                        <td>Rs. ${parseFloat(data.opening_balance).toFixed(2)}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteRecord('ob', ${data.opening_balance})">Delete</button>
                        </td>
                    </tr>
                `;
            } else {
                obTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No data available</td></tr>';
            }

            // Update the table headers for Opening Balance
            const obTableHeader = obTable.querySelector('thead tr');
            obTableHeader.innerHTML = `
                <th>S.No</th>
                <th>Amount</th>
                <th>Action</th>
            `;

            // Display GC data
            if (data.gc && data.gc.length > 0) {
                data.gc.forEach((item, index) => {
                    $('#gcTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>GC-${item.receipt_range_start} to GC-${item.receipt_range_end}</td>
                            <td>${item.receipts_count}</td>
                            <td>Rs. ${item.total_cost}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('gc', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    gcTotal += parseFloat(item.total_cost); // MODIFIED: Calculate GC total
                });
            } else {
                $('#gcTable tbody').append('<tr><td colspan="5" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display GC total
            $('#gcTotal').text(`Ghee/Coconut Total: Rs. ${gcTotal.toFixed(2)}`);

            // Display ML data
            if (data.ml && data.ml.length > 0) {
                data.ml.forEach((item, index) => {
                    $('#mlTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>ML-${item.receipt_range_start} to ML-${item.receipt_range_end}</td>
                            <td>${item.receipts_count}</td>
                            <td>Rs. ${item.total_cost}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('ml', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    mlTotal += parseFloat(item.total_cost); // MODIFIED: Calculate ML total
                });
            } else {
                $('#mlTable tbody').append('<tr><td colspan="5" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display ML total
            $('#mlTotal').text(`Maaladharane Total: Rs. ${mlTotal.toFixed(2)}`);

            // Display Irumudi data
            if (data.irumudi && data.irumudi.length > 0) {
                data.irumudi.forEach((item, index) => {
                    $('#irumudiTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>IR-${item.receipt_number}</td>
                            <td>Rs. ${item.amount}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('irumudi', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    irumudiTotal += parseFloat(item.amount); // MODIFIED: Calculate Irumudi total
                });
            } else {
                $('#irumudiTable tbody').append('<tr><td colspan="4" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display Irumudi total
            $('#irumudiTotal').text(`Irumudi Total: Rs. ${irumudiTotal.toFixed(2)}`);

            // Display Donation data
            if (data.donation && data.donation.length > 0) {
                data.donation.forEach((item, index) => {
                    $('#donationTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>DN-${item.receipt_number}</td>
                            <td>Rs. ${item.amount}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('donation', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    donationTotal += parseFloat(item.amount); // MODIFIED: Calculate Donation total
                });
            } else {
                $('#donationTable tbody').append('<tr><td colspan="4" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display Donation total
            $('#donationTotal').text(`Donation Total: Rs. ${donationTotal.toFixed(2)}`);

            // Display Material data
            if (data.material && data.material.length > 0) {
                data.material.forEach((item, index) => {
                    $('#materialTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>MT-${item.receipt_number}</td>
                            <td>Rs. ${item.amount}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('material', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    materialTotal += parseFloat(item.amount); // MODIFIED: Calculate Material total
                });
            } else {
                $('#materialTable tbody').append('<tr><td colspan="4" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display Material total
            $('#materialTotal').text(`Material Total: Rs. ${materialTotal.toFixed(2)}`);

            // Display UPI data
            if (data.upi && data.upi.length > 0) {
                data.upi.forEach((item, index) => {
                    $('#upiTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>Rs. ${item.amount}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('upi', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    upiTotal += parseFloat(item.amount); // MODIFIED: Calculate UPI total
                });
            } else {
                $('#upiTable tbody').append('<tr><td colspan="3" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display UPI total
            $('#upiTotalDisplay').text(`UPI Total: Rs. ${upiTotal.toFixed(2)}`);

            // Display Expense data
            if (data.expense && data.expense.length > 0) {
                data.expense.forEach((item, index) => {
                    $('#expenseTable tbody').append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.expense_name}</td>
                            <td>Rs. ${item.amount}</td>
                            <td><button class="delete-btn" onclick="deleteRecord('expense', ${item.id})">Delete</button></td>
                        </tr>
                    `);
                    expenseTotal += parseFloat(item.amount); // MODIFIED: Calculate Expense total
                });
            } else {
                $('#expenseTable tbody').append('<tr><td colspan="4" style="text-align: center;">No data available</td></tr>');
            }
            // MODIFIED: Display Expense total
            $('#expenseTotalDisplay').text(`Expense Total: Rs. ${expenseTotal.toFixed(2)}`);

            // Calculate totals with new logic
            const openingBalance = parseFloat(data.opening_balance) || 0;

            // Calculate grand total as sum of GC + ML + IR + DO + MT
            const grandTotal = gcTotal + mlTotal + irumudiTotal + donationTotal + materialTotal;
            
            // Calculate cash total as Grand Total + OB - (UPI + Expense)
            const cashTotal = grandTotal + openingBalance - (upiTotal + expenseTotal);

            // Update display
            $('#openingBalanceTotal').text('Rs. ' + openingBalance.toFixed(2));
            $('#grandTotal').text('Rs. ' + grandTotal.toFixed(2));
            $('#upiTotal').text('Rs. ' + upiTotal.toFixed(2));
            $('#cashTotal').text('Rs. ' + cashTotal.toFixed(2));
            $('#expenseTotal').text('Rs. ' + expenseTotal.toFixed(2));

            // Store totals for PDF generation
            window.tableTotals = {
                ob: openingBalance,
                gc: gcTotal,
                ml: mlTotal,
                irumudi: irumudiTotal,
                donation: donationTotal,
                material: materialTotal,
                upi: upiTotal,
                expense: expenseTotal,
                cash: cashTotal,
                grand: grandTotal
            };

            // Show report container
            document.getElementById('reportContainer').style.display = 'block';

            const reportDate = formatDateToDMY(document.getElementById('reportDate').value);
            
            // Update the report title with formatted date
            document.querySelector('.report-preview h3').textContent = `Report Preview for ${reportDate}`;
            
            // Update the PDF title
            window.reportDate = reportDate;
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("jsPDF library failed to load. Please check your internet connection.");
                return;
            }

            let doc = new jsPDF({
                orientation: "portrait",
                unit: "pt",
                format: "a4",
            });

            const selectedDate = document.getElementById("reportDate").value;
            if (!selectedDate) {
                alert("Please select a date first.");
                return;
            }

            // Format date to dd-mm-yyyy
            const formattedDate = formatDateToDMY(selectedDate);

            // Define header function
            const addHeader = () => {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text("|| Om Sri Swami Sharanam Ayyappa ||", doc.internal.pageSize.getWidth() / 2, 40, { align: "center" });
                doc.text("Sri Kaliyuga Varada Ayyappaswamy Temple", doc.internal.pageSize.getWidth() / 2, 60, { align: "center" });
                doc.text("Ranganathapura, Prashanthanagar, 6th Main Road, Bangalore - 79", doc.internal.pageSize.getWidth() / 2, 80, { align: "center" });
                doc.text(`Report for Date: ${formattedDate}`, doc.internal.pageSize.getWidth() / 2, 100, { align: "center" });
                doc.line(30, 110, doc.internal.pageSize.getWidth() - 30, 110);
            };

            // Define footer function
            const addFooter = (pageNumber) => {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text(`Page ${pageNumber}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 30, { align: "center" });
            };

            let y = 130;
            let pageNumber = 1;

            const tables = [
                { 
                    tableId: "obTable", 
                    title: "Opening Balance", 
                    totalKey: "ob", 
                    columns: [0, 1],  // Only include S.No and Amount columns in PDF
                    columnStyles: {
                        0: { cellWidth: 40 }, // S.No column width
                        1: { cellWidth: 'auto' } // Amount column width
                    }
                },
                { tableId: "gcTable", title: "Ghee/Coconut Report", totalKey: "gc", columns: [0, 1, 2, 3] },
                { tableId: "mlTable", title: "Maaladharane Report", totalKey: "ml", columns: [0, 1, 2, 3] },
                { tableId: "irumudiTable", title: "Irumudi Report", totalKey: "irumudi", columns: [0, 1, 2] },
                { tableId: "donationTable", title: "Donation Report", totalKey: "donation", columns: [0, 1, 2] },
                { tableId: "materialTable", title: "Material Report", totalKey: "material", columns: [0, 1, 2] },
                { tableId: "upiTable", title: "UPI Report", totalKey: "upi", columns: [0, 1] },
                { tableId: "expenseTable", title: "Expense Report", totalKey: "expense", columns: [0, 1, 2] },
            ];

            addHeader();

            tables.forEach(({ tableId, title, totalKey, columns, columnStyles }) => {
                const table = document.getElementById(tableId);
                if (table && table.querySelector('tbody').innerHTML.trim() !== "" && !table.querySelector('tbody').innerHTML.includes("No data available")) {
                    if (y + 100 > doc.internal.pageSize.getHeight() - 150) {
                        addFooter(pageNumber);
                        doc.addPage();
                        pageNumber++;
                        addHeader();
                        y = 130;
                    }

                    doc.text(title, doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
                    y += 20;

                    doc.autoTable({
                        html: `#${tableId}`,
                        startY: y,
                        theme: 'grid',
                        headStyles: { fillColor: [16, 223, 255] },
                        styles: { fontSize: 8 },
                        margin: { top: 130, bottom: 60 },
                        columns: columns,
                        columnStyles: columnStyles,
                        head: columns ? [columns] : undefined,
                        didDrawPage: function(data) {
                            y = data.cursor.y;
                            if (window.tableTotals[totalKey] > 0) {
                                y += 10;
                                if (y + 20 > doc.internal.pageSize.getHeight() - 60) {
                                    addFooter(pageNumber);
                                    doc.addPage();
                                    pageNumber++;
                                    addHeader();
                                    y = 130;
                                }
                                doc.setFontSize(10);
                                doc.text(`${title} Total: Rs. ${window.tableTotals[totalKey].toFixed(2)}`, doc.internal.pageSize.getWidth() - 30, y, { align: "right" });
                                y += 20;
                            }
                            addFooter(pageNumber);
                        },
                        pageBreak: 'auto'
                    });

                    y += 20;
                }
            });

            // Add summary totals to PDF
            if (y + 150 > doc.internal.pageSize.getHeight()) {
                addFooter(pageNumber);
                doc.addPage();
                pageNumber++;
                addHeader();
                y = 130;
            }

            doc.setFontSize(12);
            doc.text(`Opening Balance: ${$('#openingBalanceTotal').text()}`, 20, y + 10);
            doc.text(`Cash Total: ${$('#cashTotal').text()}`, 20, y + 30);
            doc.text(`UPI Total: ${$('#upiTotal').text()}`, 20, y + 50);
            doc.text(`Expense Total: ${$('#expenseTotal').text()}`, 20, y + 70);
            doc.text(`Grand Total: ${$('#grandTotal').text()}`, 20, y + 90);
            doc.text("Cashier Signature: ___________________", 20, y + 120);

            addFooter(pageNumber);
            
            // Save the PDF with formatted date in filename
            const fileName = `Report_${formattedDate}.pdf`;
            doc.save(fileName);
        }

        function calculateTotals(data) {
            let grandTotal = 0;
            let upiTotal = 0;
            let expenseTotal = 0;
            let openingBalance = parseFloat(data.opening_balance) || 0;

            // Calculate grand total from all income sources
            data.gc.forEach(item => {
                grandTotal += parseFloat(item.total_cost) || 0;
            });
            data.ml.forEach(item => {
                grandTotal += parseFloat(item.total_cost) || 0;
            });
            data.irumudi.forEach(item => {
                grandTotal += parseFloat(item.amount) || 0;
            });
            data.donation.forEach(item => {
                grandTotal += parseFloat(item.amount) || 0;
            });
            data.material.forEach(item => {
                grandTotal += parseFloat(item.amount) || 0;
            });
            // Add opening balance to grand total
            grandTotal += openingBalance;

            // Calculate UPI and Expense totals
            data.upi.forEach(item => {
                upiTotal += parseFloat(item.amount) || 0;
            });
            data.expense.forEach(item => {
                expenseTotal += parseFloat(item.amount) || 0;
            });

            // Calculate cash total: Grand total - (UPI + Expense)
            const cashTotal = grandTotal - (upiTotal + expenseTotal);

            return {
                grandTotal: roundToTwo(grandTotal),
                upiTotal: roundToTwo(upiTotal),
                expenseTotal: roundToTwo(expenseTotal),
                cashTotal: roundToTwo(cashTotal),
                openingBalance: roundToTwo(openingBalance)
            };
        }

        function updateSummaryDisplay(totals) {
            document.getElementById('openingBalance').textContent = `₹${totals.openingBalance}`;
            document.getElementById('cashTotal').textContent = `₹${totals.cashTotal}`;
            document.getElementById('upiTotal').textContent = `₹${totals.upiTotal}`;
            document.getElementById('expenseTotal').textContent = `₹${totals.expenseTotal}`;
            document.getElementById('grandTotal').textContent = `₹${totals.grandTotal}`;
        }
    </script>
</body>
</html>

